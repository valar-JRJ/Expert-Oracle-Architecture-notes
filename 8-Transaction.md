# 8-Transaction
Oracle中的事务体现了ACID特征
- 原子性(Atomicity): 事务中所有的动作要么都发生，要么都不发生
- 一致性(Consistency): 事务将数据库从一种状态转变为下一种状态
- 隔离性(Isolation): 一个事务的影响在该事务提交前对其他事务是不可见的
- 持久性(Durability): 事务一旦提交，其结果就是永久性的

## 事务控制语句
- COMMIT：会结束你的事务，并使得已做的所有修改持久地保存在数据库中
- ROLLBACK: 回滚会结束事务，并撤销这个是无所做的修改，撤销动作需要读取回滚段/undo段的信息，并把数据恢复到开始之前的状态
- SAVEPOINT: 创建标记点，一个事务可以有多个savepoint。常用ROLLBACK TO \<SAVEPOINT>将事务回滚到指定位置
- SET TRANSACTION：这条语句允许你设置不同的事务属性，如事务的隔离级别以及事务是只读还是可读写。
## 原子性
### 语句级原子性
为了实现语句级原子性，Oracle在每个数据库命令外面加了一个SAVEPOINT
### 过程级原子性
Oracle将整个存储过程作为一个原子性的语句处理，在外面包一个SAVEPOINT
### 事务级原子性
### DDL与原子性
数据定义语言DDL仅提供语句级原子性

1. 这些语句在开始时会先执行一个COMMIT，结束当前已有的所有事务
2. 完成DDL操作，如CREATE TABLE
3. 如果DDL操作成功，则提交，否则回滚DDL操作

## 持久性
通常情况下，一个事务提交时，它的改变就是永久性的，下面两种特定情况例外
- 使用COMMIT语句新增的WRITE扩展从句
- 在非分布式中执行COMMIT

## 完整性约束和事务
默认情况下，完整性约束会在整个SQL语句得到处理之后才进行检查，但是也有一些约束可以推迟其验证
### IMMEDIATE约束
这是一般情况。在这种情况下，完整性约束会在整个SQL语句得到处理后立即进行检查。
### DEFERRABLE约束和CASCADE UPDATE级联更新
级联更新指在一个外键关系中，对一个父表主键的更新操作之后级联更新子表上的键值。（一般来说，级联更新修改主键是很不好的做法，这违背了涉及主键的初衷）
## 分布式事务
在一个事务的范围内，我可以更新多个不同数据库中的数据：当我提交时，要么提交所有实例中的更新，要么一个都不提交。

Oracle中分布式事务的关键组件是数据库链接(database link)。数据库连接是一个数据库对象，它描述了如何从你的实例，登录到另一个实例。

Oracle使用了一个2PC(Two-Phase Commit Protical)两阶段提交协议来做到这一点。如果一个修改影响到多个不同的数据库，2PC就能保证这个修改在事务提交时的事务原子性。

如果一个2PC事务涉及到多个数据库，那么其中一个数据库会成为整个分布式事务的协调者。提交时，协调者会询问其他数据库是否已经准备好提交，每个数据库都会报告它的就绪状态。只有所有站点都就绪，协调者才会广播一条消息，使所有涉及到的数据库的提交成为永久性的；否则整个事务回滚。